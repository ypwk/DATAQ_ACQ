<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CSV Data Plot</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <!-- Added Date Adapter -->
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        background-color: #f4f4f4;
        margin: 0;
        padding: 20px;
      }
      h1 {
        color: #333;
      }
      canvas {
        width: 100%; /* Adjust width for responsiveness */
        max-width: 1200px; /* Increased max-width for larger display */
        height: 400px; /* Set height to make the charts shorter */
        margin: auto;
        margin-bottom: 40px; /* Add space between charts */
      }
    </style>
  </head>
  <body>
    <h1>Thermocouple + Pressure Data</h1>
    <h2>Pressure Data</h2>
    <canvas id="di1100Chart"></canvas>
    <h2>Thermocouple Data</h2>
    <canvas id="di245Chart"></canvas>

    <script>
      let di1100Chart, di245Chart; // Global variables to store the chart instances

      // Function to fetch and parse CSV data
      async function fetchCSVData() {
        try {
          // Fetch the CSV file from the S3 bucket
          const response = await fetch(
            "https://aqp-readout-data.s3.us-west-1.amazonaws.com/data/device_readings.csv"
          );

          const data = await response.text();

          // Parse CSV data
          const rows = data.split("\n").map((row) => row.split(","));
          const timestamps = [];
          const di1100Datasets = {};
          const di245Datasets = {};

          // Iterate over the rows and separate data into DI-1100 and DI-245 datasets
          for (let i = 1; i < rows.length; i++) {
            const [timestamp, deviceType, channel, type, value] = rows[i];
            if (!isNaN(parseFloat(value))) {
              if (!timestamps.includes(timestamp)) {
                timestamps.push(timestamp);
              }
              const key = `${deviceType} - ${channel} - ${type}`;
              if (deviceType === "DI-1100") {
                if (!di1100Datasets[key]) {
                  di1100Datasets[key] = {
                    label: key,
                    data: [],
                    borderColor: getRandomColor(),
                    backgroundColor: "rgba(75, 192, 192, 0.2)",
                    borderWidth: 1,
                  };
                }
                di1100Datasets[key].data.push({
                  x: timestamp,
                  y: parseFloat(value),
                });
              } else if (deviceType === "DI-245") {
                if (!di245Datasets[key]) {
                  di245Datasets[key] = {
                    label: key,
                    data: [],
                    borderColor: getRandomColor(),
                    backgroundColor: "rgba(192, 75, 192, 0.2)",
                    borderWidth: 1,
                  };
                }
                di245Datasets[key].data.push({
                  x: timestamp,
                  y: parseFloat(value),
                });
              }
            }
          }

          return {
            labels: timestamps,
            di1100Datasets: Object.values(di1100Datasets),
            di245Datasets: Object.values(di245Datasets),
          };
        } catch (error) {
          console.error("Error fetching CSV data:", error);
        }
      }

      // Function to generate a random color for each dataset
      function getRandomColor() {
        const r = Math.floor(Math.random() * 255);
        const g = Math.floor(Math.random() * 255);
        const b = Math.floor(Math.random() * 255);
        return `rgba(${r}, ${g}, ${b}, 1)`;
      }

      // Function to create or update the charts
      async function createCharts() {
        const { labels, di1100Datasets, di245Datasets } = await fetchCSVData();

        const ctx1100 = document.getElementById("di1100Chart").getContext("2d");
        const ctx245 = document.getElementById("di245Chart").getContext("2d");

        // Destroy the previous chart instances if they exist
        if (di1100Chart) {
          di1100Chart.destroy();
        }
        if (di245Chart) {
          di245Chart.destroy();
        }

        // Create the DI-1100 chart
        di1100Chart = new Chart(ctx1100, {
          type: "line",
          data: {
            labels: labels,
            datasets: di1100Datasets,
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              tooltip: {
                enabled: true,
                mode: "nearest",
                intersect: false,
                callbacks: {
                  title: (tooltipItems) => `Time: ${tooltipItems[0].label}`,
                  label: (tooltipItem) =>
                    `${tooltipItem.dataset.label}: ${tooltipItem.raw.y}`,
                },
              },
            },
            scales: {
              x: {
                type: "time",
                time: {
                  unit: "minute",
                  tooltipFormat: "MMM DD, YYYY HH:mm:ss",
                  displayFormats: {
                    minute: "HH:mm:ss",
                  },
                },
              },
              y: {
                beginAtZero: false,
              },
            },
          },
        });

        // Create the DI-245 chart
        di245Chart = new Chart(ctx245, {
          type: "line",
          data: {
            labels: labels,
            datasets: di245Datasets,
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              tooltip: {
                enabled: true,
                mode: "nearest",
                intersect: false,
                callbacks: {
                  title: (tooltipItems) => `Time: ${tooltipItems[0].label}`,
                  label: (tooltipItem) =>
                    `${tooltipItem.dataset.label}: ${tooltipItem.raw.y}`,
                },
              },
            },
            scales: {
              x: {
                type: "time",
                time: {
                  unit: "minute",
                  tooltipFormat: "MMM DD, YYYY HH:mm:ss",
                  displayFormats: {
                    minute: "HH:mm:ss",
                  },
                },
              },
              y: {
                beginAtZero: false,
              },
            },
          },
        });
      }

      // Call the function to create the charts
      createCharts();
    </script>
  </body>
</html>
