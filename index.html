<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CSV Data Plot</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <!-- Added Date Adapter -->
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        background-color: #f4f4f4;
        margin: 0;
        padding: 20px;
      }
      h1 {
        color: #333;
      }
      canvas {
        width: 100%; /* Adjust width for responsiveness */
        max-width: 1200px; /* Increased max-width for larger display */
        height: 600px; /* Set height to make the chart taller */
        margin: auto;
      }
    </style>
  </head>
  <body>
    <h1>Thermocouple + Pressure Data</h1>
    <canvas id="myChart"></canvas>

    <script>
      let chart; // Global variable to store the chart instance

      // Function to fetch and parse CSV data
      async function fetchCSVData() {
        try {
          // Fetch the CSV file from the S3 bucket
          const response = await fetch(
            "https://aqp-readout-data.s3.us-west-1.amazonaws.com/data/device_readings.csv"
          );

          const data = await response.text();

          // Parse CSV data
          const rows = data.split("\n").map((row) => row.split(","));
          const timestamps = [];
          const datasets = {};

          // Iterate over the rows and extract timestamps and values for each channel
          for (let i = 1; i < rows.length; i++) {
            const [timestamp, deviceType, channel, type, value] = rows[i];
            if (!isNaN(parseFloat(value))) {
              if (!timestamps.includes(timestamp)) {
                timestamps.push(timestamp);
              }
              const key = `${deviceType} - ${channel} - ${type}`;
              if (!datasets[key]) {
                datasets[key] = {
                  label: key,
                  data: [],
                  borderColor: getRandomColor(),
                  backgroundColor: "rgba(75, 192, 192, 0.2)",
                  borderWidth: 1,
                };
              }
              datasets[key].data.push({ x: timestamp, y: parseFloat(value) });
            }
          }

          return { labels: timestamps, datasets: Object.values(datasets) };
        } catch (error) {
          console.error("Error fetching CSV data:", error);
        }
      }

      // Function to generate a random color for each dataset
      function getRandomColor() {
        const r = Math.floor(Math.random() * 255);
        const g = Math.floor(Math.random() * 255);
        const b = Math.floor(Math.random() * 255);
        return `rgba(${r}, ${g}, ${b}, 1)`;
      }

      // Function to create or update the chart
      async function createChart() {
        const { labels, datasets } = await fetchCSVData();

        const ctx = document.getElementById("myChart").getContext("2d");

        // Destroy the previous chart instance if it exists
        if (chart) {
          chart.destroy();
        }

        // Create a new chart instance
        chart = new Chart(ctx, {
          type: "line", // You can change this to 'bar', 'pie', etc.
          data: {
            labels: labels,
            datasets: datasets,
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              tooltip: {
                enabled: true, // Enable tooltips
                mode: "nearest", // Show the nearest tooltip on hover
                intersect: false, // Show tooltip even if not directly on the point
                callbacks: {
                  title: (tooltipItems) => {
                    // Customize the title of the tooltip
                    return `Time: ${tooltipItems[0].label}`;
                  },
                  label: (tooltipItem) => {
                    // Customize the label of the tooltip
                    return `${tooltipItem.dataset.label}: ${tooltipItem.raw.y}`;
                  },
                },
              },
            },
            scales: {
              x: {
                type: "time",
                time: {
                  unit: "minute",
                  tooltipFormat: "MMM DD, YYYY HH:mm:ss",
                  displayFormats: {
                    minute: "HH:mm:ss",
                  },
                },
              },
              y: {
                beginAtZero: false,
              },
            },
          },
        });
      }

      // Call the function to create the chart
      createChart();
    </script>
  </body>
</html>
